<!-- -*- tab-width: 4; -*- -->

<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Assembling FizzBuzz</title>
  <link rel="stylesheet" href="../css/default.css" />
  <link rel="stylesheet" href="../css/syntax.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="icon" type="image/png" href="../images/favicon.png">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X0Q4TM37FN"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-X0Q4TM37FN');
</script>
</head>

<body>
  <header>
    <div class="header-page">
      <span class="header-page-link">
        <svg class="logo" data-name="Lab notes - logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 726 726" data-href="/" xmlns:xlink="http://www.w3.org/1999/xlink">
  <a xlink:href="/">
    <rect id="link-fill" stroke="none" width="726" height="726" rx="47.41" ry="47.41"></rect>
  </a>

  <title>Assembling FizzBuzz</title>

  <rect id="bg" width="726" height="726" rx="47.41" ry="47.41"></rect>

  <g>
    <path id="letter" d="M1533.7,1732.64c-9.79-25.5-19.58-51-28.48-81.14h-4.45c-6.23,24.73-17.8,53.32-27.59,78.82l-88.1,216.38h-81.87L1459,1600.49c3.56-8.5,5.34-13.91,5.34-17.77,0-4.64-1.78-11.59-6.23-20.87-27.59-65.68-59.62-117.46-112.12-117.46a105.24,105.24,0,0,0-15.13.77l7.12-52.55c7.12-2.32,19.58-3.09,30.26-3.09,84.54,0,124.58,70.32,170.85,177l164.62,380.2h-82.76Z" transform="translate(-1144 -1314)"></path>
  </g>
</svg>

      </span>

      <h1>Assembling FizzBuzz</h1>
    </div>
  </header>

  <main role="main">
    <article>
    <section class="header">
        Posted on January 16, 2019
        
    </section>
    <section>
        <p>The <a href="https://artempyanykh.com/blog/posts/2018-12-31-assembling-noop.html">previous post</a> covers preliminary topics that include tool-chain, compiling assembly programs and turning them into executables, a bit about anatomy of Mach-O object files, and finally SysV ABI and system calls.</p>
<p>With that out of the way, we are ready to get serious and solve some real problems… like FizzBuzz. This time around we’ll be doing dynamic linking with C runtime, using library functions, accessing command line arguments, and, of course, fighting segfaults.</p>
<p>This <strong>is not</strong> a post about how to solve a FizzBuzz. The problems is used merely as a means to illustrate low-level aspects of linking, executable loading, lazy symbol binding, etc.</p>
<!--more-->

<p><strong>Table of contents</strong>:</p>
<ol>
<li><a href="#problem">Problem statement</a></li>
<li><a href="#dynex">Dynamic executable</a></li>
<li><a href="#howto-libs">How to use library functions</a>
<ol>
<li><a href="#howto-print">How to print</a></li>
<li><a href="#stack-align">(Aside) When is stack alignment really required?</a></li>
<li><a href="#linker">(Aside) How <code>printf</code> is actually linked to the executable?</a></li>
<li><a href="#howto-parse">How to parse command line args</a></li>
</ol></li>
<li><a href="#asm-sol">Finally, a solution to FizzBuzz</a></li>
<li><a href="#other-lang-sols">(Bonus) FizzBuzz in other languages</a>
<ol>
<li><a href="#c-sol">Effectiveness of C</a></li>
<li><a href="#haskell-sol">Expressiveness of Haskell</a></li>
<li><a href="#python-sol">Whatever of Python</a></li>
</ol></li>
<li><a href="#footnotes">Footnotes</a></li>
</ol>
<h1 id="problem">Problem statement</h1>
<p>Below is the original FizzBuzz problem statement:</p>
<blockquote>
<p>For each number from 1 to 100: print ‘Fizz’ if a number is divisible by 3, print ‘Buzz’ if it is divisible by 5, and print ‘FizzBuzz’ if it’s divisible by both 3 and 5.</p>
</blockquote>
<p>To make things a bit more interesting (kek) we will work with numbers from <code>1</code> to <code>n</code> where <code>n</code> is a command line parameter.</p>
<p>Breaking down this problem further, we can identify specific pieces of functionality needed to implement a solution:</p>
<ol>
<li>Access command line arguments to read <code>n</code>.</li>
<li>Parse a string representation of <code>n</code> into a number.</li>
<li>Print to stdout either a string or a number.</li>
<li>Arithmetic, logic and jumps to implement the logic of the method.</li>
</ol>
<p>We could implement everything in pure assembly using only syscalls, but it would get rather tedious very soon. Instead we’ll use familiar printing and parsing functions from C stdlib (which we will link to dynamically), and use assembly only for the main control flow.</p>
<h1 id="dynex">Dynamic executable</h1>
<p>Previously, we were building statically linked executables. Static linking has its benefits as the resulting binary is self-contained and there are no runtime overhead to method calls and variable references induced by the usage of the dynamic linker. However, the final image size is larger and since library code is not shared memory consumption is higher. Depending on the use case, either static or dynamic linking may be preferable.</p>
<p>There are no practical differences between static and dynamic linking for our case though. So, let’s take a look at the code of a dynamic no-op executable that just return an exit code equal to 42, and then move on to the fun part:</p>
<div class="sourceCode" id="cb1" data-startFrom data-tangle="asm-min-dyn.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb1-2"><a href="#cb1-2"></a>        GLOBAL _main            <span class="co">; (1)</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">_main:</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">42</span>         <span class="co">; (2)</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>        <span class="bu">ret</span>                     <span class="co">; (3)</span></span></code></pre></div>
<p>To compile and link it we can use the following commands:</p>
<div class="sourceCode" id="cb2" data-startFrom data-results="none"><pre class="sourceCode numberSource shell numberLines"><code class="sourceCode"><span id="cb2-1"><a href="#cb2-1"></a>nasm asm-min-dyn.asm -f macho64 -o build64/asm-min-dyn.o</span>
<span id="cb2-2"><a href="#cb2-2"></a>ld build64/asm-min-dyn.o -lc -o bin/asm-min-dyn</span>
<span id="cb2-3"><a href="#cb2-3"></a>#                         ^ (4)</span></code></pre></div>
<p>There are several things to note here:</p>
<ol>
<li><code>_main</code> is no longer a real entry point in our program. When the executable is loaded the control is passed to the dynamic linker, which initializes C runtime among other things, and only after that <code>_main</code> is called.</li>
<li>Since <code>_main</code> is called in a regular way, all calling conventions apply to it, in particular its integer result (exit code) should be returned in <code>rax</code>.</li>
<li>We don’t need to make an <code>exit</code> syscall. Instead we just return control to the code that called <code>_main</code> which in turn will do a proper termination.</li>
<li>The executable needs to be linked with <code>libc</code>. Otherwise linking fails with an error.</li>
</ol>
<p>Running this binary produces the expected results:</p>
<div class="sourceCode" id="cb3" data-startFrom><pre class="sourceCode numberSource shell numberLines"><code class="sourceCode"><span id="cb3-1"><a href="#cb3-1"></a>bin/asm-min-dyn</span>
<span id="cb3-2"><a href="#cb3-2"></a>echo $?</span></code></pre></div>
<pre class="example"><code>42
</code></pre>
<p>Now that we know how to build dynamic executables and link with <code>libc</code> let’s proceed to the next section.</p>
<h1 id="howto-libs">How to use library functions</h1>
<p>We’ve identified 2 pieces of functionality that we need from <code>libc</code>: printing and parsing. For no particular reason we’ll start with printing, and implement a hello world.</p>
<h2 id="howto-print">How to print</h2>
<p>Let’s look at the code first, and then proceed with a commentary about highlighted parts:</p>
<div class="sourceCode" id="cb5" data-startFrom data-tangle="helloworld.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1"></a>        GLOBAL _main</span>
<span id="cb5-2"><a href="#cb5-2"></a>        EXTERN _printf          <span class="co">; (1)</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>        helloworldstr   <span class="dt">db</span>      <span class="st">'Hello World!'</span>, `\n`, <span class="dv">0</span> <span class="co">; (2)</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="fu">_main:</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, <span class="dv">8</span>                  <span class="co">; (3.1)</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, helloworldstr      <span class="co">; (3.2)</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>        <span class="bu">xor</span>     <span class="kw">al</span>, <span class="kw">al</span>                  <span class="co">; (3.3)</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>        <span class="bu">call</span>    _printf</span>
<span id="cb5-13"><a href="#cb5-13"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span>                  <span class="co">; (3.4)</span></span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>Now to the highlights from the code:</p>
<ol>
<li>Using library functions is pretty straightforward – it only requires an <code>EXTERN</code> declaration somewhere in the source code. On MacOS symbol names need to be prefixed with an underscore <code>_</code>, so it’s <code>_printf</code> instead of <code>printf</code>.</li>
<li><code>.data</code> section is used to declare initialized memory regions. In this particular case we define a label <code>helloworldstr</code> that points to the beginning of a byte array declared with <code>db</code> whose contents correspond to a zero-terminated string “Hello World!” ended by a line-feed.</li>
<li>This part of the assembly does necessary preparations and calls <code>printf</code>.
<ol>
<li>According to the calling conventions, the stack should be 16-byte aligned before the <code>call</code> instruction. Since <code>call</code> itself places on the stack a return address (8 bytes on 64-bit machines), we need to subtract an additional 8 bytes to align the stack.</li>
<li>First parameter of <code>printf</code> is a pointer to the format string. We supply the address pointing to <code>helloworlstr</code> in <code>rdi</code> register according to the calling conventions.</li>
<li><code>printf</code> is a variadic function. Such functions accept a number of floating point arguments in <code>al</code> register, and since we don’t pass any, the register is zeroed out.</li>
<li>After the function call, we need to restore a previous value of the stack pointer. Failure to do so will most likely result in a segmentation fault when <code>ret</code> pops a bogus value from the stack.</li>
</ol></li>
</ol>
<p>Commands to link and compile this program are the same as above. To save the clutter, I wrote a Makefile to manage the build, and will use <code>make &lt;target&gt;</code> instead of full commands on this and future occasions.</p>
<div class="sourceCode" id="cb6" data-startFrom data-results="verbatim"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">make</span> helloworld <span class="op">&gt;</span> /dev/null</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ex">bin/helloworld</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="bu">echo</span> <span class="va">$?</span></span></code></pre></div>
<pre class="example"><code>Hello World!
0
</code></pre>
<p>Since we will need to print both strings and numbers, it makes sense to write a macro for this. Macros will be stores in a separate file and included in the main source file with a special NASM directive.</p>
<div class="sourceCode" id="printmacro" data-startFrom data-tangle="printmacro.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="printmacro-1"><a href="#printmacro-1"></a><span class="co">;;; Prints a string to stdout.</span></span>
<span id="printmacro-2"><a href="#printmacro-2"></a><span class="co">;;; Parameter 1 -- a pointer to the string to print.</span></span>
<span id="printmacro-3"><a href="#printmacro-3"></a><span class="co">;;; Parameter 2 -- a constant sub to align the stack.</span></span>
<span id="printmacro-4"><a href="#printmacro-4"></a>        %<span class="pp">macro</span>  print0 <span class="dv">2</span></span>
<span id="printmacro-5"><a href="#printmacro-5"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, %<span class="dv">2</span></span>
<span id="printmacro-6"><a href="#printmacro-6"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, %<span class="dv">1</span></span>
<span id="printmacro-7"><a href="#printmacro-7"></a>        <span class="bu">xor</span>     <span class="kw">al</span>, <span class="kw">al</span></span>
<span id="printmacro-8"><a href="#printmacro-8"></a>        <span class="bu">call</span>    _printf</span>
<span id="printmacro-9"><a href="#printmacro-9"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, %<span class="dv">2</span></span>
<span id="printmacro-10"><a href="#printmacro-10"></a>        %endmacro</span>
<span id="printmacro-11"><a href="#printmacro-11"></a></span>
<span id="printmacro-12"><a href="#printmacro-12"></a><span class="co">;;; Prints a string with an integer pattern inside.</span></span>
<span id="printmacro-13"><a href="#printmacro-13"></a><span class="co">;;; Parameter 1 -- a pointer to the format string.</span></span>
<span id="printmacro-14"><a href="#printmacro-14"></a><span class="co">;;; Parameter 2 -- a number to print.</span></span>
<span id="printmacro-15"><a href="#printmacro-15"></a><span class="co">;;; Parameter 3 -- a constant sub to align the stack.</span></span>
<span id="printmacro-16"><a href="#printmacro-16"></a>        %<span class="pp">macro</span>  print1 <span class="dv">3</span></span>
<span id="printmacro-17"><a href="#printmacro-17"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, %<span class="dv">3</span></span>
<span id="printmacro-18"><a href="#printmacro-18"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, %<span class="dv">1</span></span>
<span id="printmacro-19"><a href="#printmacro-19"></a>        <span class="bu">mov</span>     <span class="kw">rsi</span>, %<span class="dv">2</span></span>
<span id="printmacro-20"><a href="#printmacro-20"></a>        <span class="bu">xor</span>     <span class="kw">al</span>, <span class="kw">al</span></span>
<span id="printmacro-21"><a href="#printmacro-21"></a>        <span class="bu">call</span>    _printf</span>
<span id="printmacro-22"><a href="#printmacro-22"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, %<span class="dv">3</span></span>
<span id="printmacro-23"><a href="#printmacro-23"></a>        %endmacro</span></code></pre></div>
<p>With this macros included, we can easily print both pure strings and formatted strings with an integer argument:</p>
<div class="sourceCode" id="cb8" data-startFrom data-tangle="hw-macro.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1"></a>        GLOBAL _main</span>
<span id="cb8-2"><a href="#cb8-2"></a>        EXTERN _printf</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>        hellostr        <span class="dt">db</span>      <span class="st">'Hello, there!'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>        todaynumstr     <span class="dt">db</span>      <span class="st">&quot;Today'</span>s number is %d<span class="st">&quot;, `\n`, 0</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="fu">_main:</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>        print0  hellostr, <span class="dv">8</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>        print1  todaynumstr, <span class="dv">42</span>, <span class="dv">8</span></span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>        <span class="bu">ret</span></span></code></pre></div>
<div class="sourceCode" id="cb9" data-startFrom data-results="verbatim"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">make</span> hw-macro <span class="op">&gt;</span> /dev/null</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="ex">bin/hw-macro</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">echo</span> <span class="va">$?</span></span></code></pre></div>
<pre class="example"><code>Hello, there!
Today's number is 42
0
</code></pre>
<h2 id="stack-align">(Aside) When is stack alignment really required?</h2>
<p>Suppose that we forgot aligning the stack. To simulate this, it’s enough to set to <code>0</code> the second parameter to <code>print0</code>.</p>
<div class="sourceCode" id="cb11" data-startFrom data-tangle="unaligned-stack.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb11-1"><a href="#cb11-1"></a>        GLOBAL _main</span>
<span id="cb11-2"><a href="#cb11-2"></a>        EXTERN _printf</span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>        hellostr        <span class="dt">db</span>      <span class="st">'Hello, there!'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">_main:</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>        print0  hellostr, <span class="dv">0</span></span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>        <span class="bu">ret</span></span></code></pre></div>
<div class="sourceCode" id="cb12" data-startFrom data-results="none"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">make</span> unaligned-stack <span class="op">&gt;</span> /dev/null</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">bin/unaligned-stack</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="bu">echo</span> <span class="va">$?</span></span></code></pre></div>
<p>The program compiles just fine, but during execution fails with a segmentation fault:</p>
<pre class="example"><code>[1]    56909 segmentation fault  bin/unaligned-stack
139
</code></pre>
<p>A short session in debugger shows that it’s not even <code>printf</code> triggering this error, but it’s rather an explicit check in the dynamic linker:</p>
<pre class="example"><code>libdyld.dylib`dyld_stub_binder:
-&gt;  0x7fff6b5f5ac4 &lt;+0&gt;:  push   rbp
    0x7fff6b5f5ac5 &lt;+1&gt;:  test   rsp, 0xf
    0x7fff6b5f5acc &lt;+8&gt;:  jne    0x7fff6b5f5c56 ; stack_not_16_byte_aligned_error
</code></pre>
<p>A couple steps forward show exactly how this <code>stack_not_16_byte_aligned_error</code> is implemented:</p>
<pre class="example"><code>libdyld.dylib`stack_not_16_byte_aligned_error:
-&gt;  0x7fff6b5f5c56 &lt;+0&gt;: movdqa xmmword ptr [rsp], xmm0
</code></pre>
<p><code>movdqa</code> instruction moves aligned 128 bits of memory into <code>xmm0</code> register. When memory is not aligned the processor generates a general protection exception that translates to a segmentation fault.</p>
<p>Now consider a slightly modified example. The code is the same as before, except that there is a second call to <code>printf</code> and:</p>
<ul>
<li>the first call has proper alignment,</li>
<li>the second call doesn’t have stack properly aligned.</li>
</ul>
<div class="sourceCode" id="cb16" data-startFrom data-tangle="unaligned-stack-2.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb16-1"><a href="#cb16-1"></a>        GLOBAL _main</span>
<span id="cb16-2"><a href="#cb16-2"></a>        EXTERN _printf</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>        hellostr        <span class="dt">db</span>      <span class="st">'Hello, there!'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="fu">_main:</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>        print0  hellostr, <span class="dv">8</span>     <span class="co">; 1st call to printf with properly aligned stack</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>        print0  hellostr, <span class="dv">0</span>     <span class="co">; (+) unaligned call to print0</span></span>
<span id="cb16-13"><a href="#cb16-13"></a></span>
<span id="cb16-14"><a href="#cb16-14"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>It would be natural to expect this program to segfault on the second <code>print0</code>. However, the program runs just fine:</p>
<div class="sourceCode" id="cb17" data-startFrom data-results="verbatim"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">make</span> unaligned-stack-2 <span class="op">&gt;</span> /dev/null</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ex">bin/unaligned-stack-2</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="bu">echo</span> <span class="va">$?</span></span></code></pre></div>
<pre class="example"><code>Hello, there!
Hello, there!
0
</code></pre>
<p>So, what’s going on here? A more detailed answer is provided in the following aside where linker’s work is explored in more detail. But in short, control goes to the dynamic linker only on a first call of a function when it does lazy symbol binding. For consecutive calls the memory location of <code>printf</code> is already known, so control goes directly there. Luckily, the code path in <code>printf</code> doesn’t have any instruction that require memory alignment<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, so the call to <code>printf</code> finishes without issues, even though stack alignment is violated.</p>
<p>One thing to keep in mind is that stack alignment and other calling convention are <em>just conventions</em>. Unless you need to call/use external methods, you are free to do whatever you want with the stack and the registers.</p>
<h2 id="linker">(Aside) How <code>printf</code> is actually linked to the executable?</h2>
<p>The only thing we need to use <code>printf</code> in our code, is define it with <code>EXTERN</code> keyword:</p>
<div class="sourceCode" id="cb19" data-startFrom data-tangle="helloworld.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb19-1"><a href="#cb19-1"></a>        GLOBAL _main</span>
<span id="cb19-2"><a href="#cb19-2"></a>        EXTERN _printf</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>        helloworldstr   <span class="dt">db</span>      <span class="st">'Hello World!'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="fu">_main:</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, <span class="dv">8</span></span>
<span id="cb19-10"><a href="#cb19-10"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, helloworldstr</span>
<span id="cb19-11"><a href="#cb19-11"></a>        <span class="bu">xor</span>     <span class="kw">al</span>, <span class="kw">al</span></span>
<span id="cb19-12"><a href="#cb19-12"></a>        <span class="bu">call</span>    _printf</span>
<span id="cb19-13"><a href="#cb19-13"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span></span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>The assembler doesn’t know what <code>printf</code> is and where it will eventually come from. So, when it compiles the source code into an object file, it leaves a note in a form of a <strong>relocation entry</strong><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> to the linker that later builds a final executable object file.</p>
<p>We can peek into the assembly generated for <code>printf</code> call using <code>objdump</code> tool:</p>
<div class="sourceCode" id="cb20" data-startFrom data-results="verbatim"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">objdump</span> -disassemble build64/helloworld.o <span class="kw">|</span> <span class="fu">grep</span> call</span></code></pre></div>
<pre class="example"><code>      10:	e8 00 00 00 00 	callq	0 &lt;_main+0x15&gt;
</code></pre>
<p>The address<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> of <code>printf</code> is replaced with 0. This can’t be it, since <code>call 0</code> just passes control to the next instruction. The missing part is the relocation table also generated by the assembler. For <code>printf</code> the entry is the following:</p>
<div class="sourceCode" id="cb22" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">objdump</span> -r build64/helloworld.o <span class="kw">|</span> <span class="fu">grep</span> printf</span></code></pre></div>
<pre class="example"><code>0000000000000011 X86_64_RELOC_BRANCH _printf
</code></pre>
<p>First comes the address where the linker needs to do the relocation, then the type of relocation, and finally the name of the symbol.</p>
<p>Note above that <code>call</code> instruction start at address <code>10</code>: first byte is the opcode, and bytes 11–14 need to be filled with <code>printf</code>’s displacement. This matches the address in the relocation entry for <code>printf</code>.</p>
<p>So far, so good. When the linker does it’s job, we get an executable object file which can be loaded by the kernel. However, not all relocations are done yet. Because <code>libc</code> is linked dynamically to the executable, loading and binding of <code>printf</code> will happen at runtime.</p>
<p>To illustrate the mechanics, we will refer to <code>unaligned-stack-2</code> program from the previous section: two calls to <code>printf</code> — one with aligned stack, and the other with incorrect alignment:</p>
<div class="sourceCode" id="cb24" data-startFrom data-tangle="unaligned-stack-2.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb24-1"><a href="#cb24-1"></a>        GLOBAL _main</span>
<span id="cb24-2"><a href="#cb24-2"></a>        EXTERN _printf</span>
<span id="cb24-3"><a href="#cb24-3"></a></span>
<span id="cb24-4"><a href="#cb24-4"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb24-5"><a href="#cb24-5"></a></span>
<span id="cb24-6"><a href="#cb24-6"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>        hellostr        <span class="dt">db</span>      <span class="st">'Hello, there!'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb24-8"><a href="#cb24-8"></a></span>
<span id="cb24-9"><a href="#cb24-9"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="fu">_main:</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>        print0  hellostr, <span class="dv">8</span>     <span class="co">; 1st call to printf with properly aligned stack</span></span>
<span id="cb24-12"><a href="#cb24-12"></a>        print0  hellostr, <span class="dv">0</span>     <span class="co">; (+) unaligned invocation of print0</span></span>
<span id="cb24-13"><a href="#cb24-13"></a></span>
<span id="cb24-14"><a href="#cb24-14"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>Now, this is a bit more involved as we need to look at and connect several pieces of information. First part is the <strong><strong>resulting assembly</strong></strong> in the linked executable:</p>
<div class="sourceCode" id="cb25" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="ex">objdump</span> -disassemble -no-show-raw-insn bin/unaligned-stack-2</span></code></pre></div>
<div class="sourceCode" id="cb26" data-startFrom><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb26-1"><a href="#cb26-1"></a>bin/unaligned-<span class="bu">stack</span><span class="dv">-2</span>:	<span class="dt">file</span> <span class="bu">format</span> Mach-O <span class="dv">64</span>-bit x86<span class="dv">-64</span></span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a>Disassembly of <span class="bu">section</span> __TEXT,__text:</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="fu">_main:</span></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="fu">    1fa6:</span>	subq<span class="bn">	$8, </span>%<span class="kw">rsp</span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="fu">    1faa:</span>	movabsq<span class="bn">	$8216, </span>%<span class="kw">rdi</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="fu">    1fb4:</span>	xorb	%<span class="kw">al</span>, %<span class="kw">al</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="fu">    1fb6:</span>	callq	<span class="dv">35</span>           <span class="co">; (1) goto 0x1fde</span></span>
<span id="cb26-9"><a href="#cb26-9"></a><span class="fu">    1fbb:</span>	addq<span class="bn">	$8, </span>%<span class="kw">rsp</span></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="fu">    1fbf:</span>	subq<span class="bn">	$0, </span>%<span class="kw">rsp</span></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="fu">    1fc3:</span>	movabsq<span class="bn">	$8216, </span>%<span class="kw">rdi</span></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="fu">    1fcd:</span>	xorb	%<span class="kw">al</span>, %<span class="kw">al</span></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="fu">    1fcf:</span>	callq	<span class="dv">10</span>           <span class="co">; (1) goto 0x1fde</span></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="fu">    1fd4:</span>	addq<span class="bn">	$0, </span>%<span class="kw">rsp</span></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="fu">    1fd8:</span>	movl<span class="bn">	$0, </span>%<span class="kw">eax</span></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="fu">    1fdd:</span>	retq</span>
<span id="cb26-17"><a href="#cb26-17"></a>Disassembly of <span class="bu">section</span> __TEXT,__stubs:</span>
<span id="cb26-18"><a href="#cb26-18"></a><span class="fu">__stubs:</span></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="fu">    1fde:</span>	jmpq	*<span class="dv">44</span>(%rip)    <span class="co">; (2) goto address stored at loc 0x2010</span></span>
<span id="cb26-20"><a href="#cb26-20"></a>Disassembly of <span class="bu">section</span> __TEXT,__stub_helper:</span>
<span id="cb26-21"><a href="#cb26-21"></a><span class="fu">__stub_helper:</span></span>
<span id="cb26-22"><a href="#cb26-22"></a><span class="fu">    1fe4:</span>	leaq	<span class="dv">29</span>(%rip), %<span class="kw">r11</span></span>
<span id="cb26-23"><a href="#cb26-23"></a><span class="fu">    1feb:</span>	pushq	%<span class="kw">r11</span></span>
<span id="cb26-24"><a href="#cb26-24"></a><span class="fu">    1fed:</span>	jmpq	*<span class="dv">13</span>(%rip)      <span class="co">; (3) goto address stored at loc 0x2000</span></span>
<span id="cb26-25"><a href="#cb26-25"></a><span class="fu">    1ff3:</span>	<span class="bu">nop</span></span>
<span id="cb26-26"><a href="#cb26-26"></a><span class="fu">    1ff4:</span>	pushq<span class="bn">	$0</span></span>
<span id="cb26-27"><a href="#cb26-27"></a><span class="fu">    1ff9:</span>	<span class="bu">jmp</span>	<span class="dv">-26</span> &lt;__stub_helper&gt;</span></code></pre></div>
<p>Then, <strong><strong>contents of sections <code>__la_symbol_ptr</code> and <code>__nl_symbol_ptr</code></strong></strong><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>:</p>
<div class="sourceCode" id="cb27" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="ex">objdump</span> -section=__la_symbol_ptr -section=__nl_symbol_ptr -s bin/unaligned-stack-2 <span class="kw">|</span> <span class="fu">tail</span> -n 4</span></code></pre></div>
<pre class="example"><code>Contents of section __nl_symbol_ptr:
 2000 00000000 00000000 00000000 00000000  ................ ; (4)
Contents of section __la_symbol_ptr:
 2010 f41f0000 00000000                    ........         ; (5)
</code></pre>
<p>And finally, <strong><strong>bind and lazy bind tables</strong></strong>, which again are static pieces of information encoded in the executable:</p>
<div class="sourceCode" id="cb29" data-startFrom data-results="verbatim"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">objdump</span> -bind -lazy-bind bin/unaligned-stack-2</span></code></pre></div>
<pre class="example"><code>   : Bind table:
   : segment  section            address    type       addend dylib            symbol
(6): __DATA   __nl_symbol_ptr    0x00002000 pointer         0 libSystem        dyld_stub_binder
   :
   : Lazy bind table:
   : segment  section            address     dylib            symbol
(7): __DATA   __la_symbol_ptr    0x00002010 libSystem        _printf
</code></pre>
<p>The linker did necessary static relocations and prepared the object file for handling by the dynamic linker. Note numbered highlights in the outputs above:</p>
<ol>
<li>From (1) we see that calls to <code>printf</code> transfer control to address <code>0x1fde</code> where the stub is placed by the linker.</li>
<li>The instruction at <code>0x1fde</code> passes control to the address stored at memory location <code>0x2010</code>. From (5) we can see that initially <code>0x2010</code> stores address <code>0x1ff4</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> which pushes 0 onto the stack and jumps to the beginning of <code>__stub_helper</code> in the assembly above. From (7) we can see that <code>0x2010</code> is reserved for <code>printf</code> binding.</li>
<li>Following <code>0x1fe4</code>, there is another instruction at <code>0x1fed</code> that transfers control to the address stored at memory location <code>0x2000</code>. Bind entry (6) shows that <code>0x2000</code> will point to <code>dyld_stub_binder</code> which is a part of the dynamic linker. Initial value of <code>0x2000</code> is zero and is filled with a real address at executable load time.</li>
</ol>
<p>Dynamic linking and lazy binding requires a level of indirection: function calls no longer point directly to the destination address, but rather retrieve this address from a memory location that is filled at execution time by the dynamic linker.</p>
<p>To get a better feel for how lazy binding works, let’s fire up a debugger and see it in action:</p>
<pre class="example"><code>Current executable set to 'bin/unaligned-stack-2' (x86_64).

#
# Before the executable is loaded, 0x2000 holds 0s and 0x2010 points to 0x1ff4
#
(lldb) mem read 0x2000 --count 8
0x00002000: 00 00 00 00 00 00 00 00                          ........
(lldb) mem read 0x2010 --count 8
0x00002010: f4 1f 00 00 00 00 00 00                          .......

#
# Set breakpoint on main and run the program
#
(lldb) b main
Breakpoint 1: where = unaligned-stack-2`main, address = 0x0000000000001fa6
(lldb) r
Process 70864 launched: 'bin/unaligned-stack-2' (x86_64)
Process 70864 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000000001fa6 unaligned-stack-2`main
unaligned-stack-2`main:
-&gt;  0x1fa6 &lt;+0&gt;:  sub    rsp, 0x8
    0x1faa &lt;+4&gt;:  movabs rdi, 0x2018
    0x1fb4 &lt;+14&gt;: xor    al, al
    0x1fb6 &lt;+16&gt;: call   0x1fde                    ; symbol stub for: printf
Target 0: (unaligned-stack-2) stopped.

#
# After the executable is loaded 0x2000 points to a real address
# to the dynamic linker stub binder.
#
(lldb) mem read 0x2000 --count 8
0x00002000: c4 5a 5f 6b ff 7f 00 00                          Z_k...

#
# Set a breakpoint after the first call to printf and continue execution
#
(lldb) b 0x1fbb
Breakpoint 2: where = unaligned-stack-2`main + 21, address = 0x0000000000001fbb
(lldb) c
Process 70864 resuming
Hello, there!
Process 70864 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 2.1
    frame #0: 0x0000000000001fbb unaligned-stack-2`main + 21
unaligned-stack-2`main:
-&gt;  0x1fbb &lt;+21&gt;: add    rsp, 0x8
    0x1fbf &lt;+25&gt;: sub    rsp, 0x0
    0x1fc3 &lt;+29&gt;: movabs rdi, 0x2018
    0x1fcd &lt;+39&gt;: xor    al, al
Target 0: (unaligned-stack-2) stopped.

#
# After the first call to printf, 0x2010 stores a memory address
# where printf was actually loaded to.
#
(lldb) mem read 0x2010 --count 8
0x00002010: ec 78 69 6b ff 7f 00 00                          xik...
(lldb) dis -s 0x7fff6b6978ec
libsystem_c.dylib`printf:
    0x7fff6b6978ec &lt;+0&gt;:  push   rbp
    0x7fff6b6978ed &lt;+1&gt;:  mov    rbp, rsp
    0x7fff6b6978f0 &lt;+4&gt;:  sub    rsp, 0xd0
    0x7fff6b6978f7 &lt;+11&gt;: mov    r10, rdi
    0x7fff6b6978fa &lt;+14&gt;: test   al, al
    0x7fff6b6978fc &lt;+16&gt;: je     0x7fff6b697924            ; &lt;+56&gt;
    0x7fff6b6978fe &lt;+18&gt;: movaps xmmword ptr [rbp - 0xa0], xmm0
    0x7fff6b697905 &lt;+25&gt;: movaps xmmword ptr [rbp - 0x90], xmm1
</code></pre>
<h2 id="howto-parse">How to parse command line args</h2>
<p>Since our <code>main</code> is not an entry point but rather a regular function, we can expect <code>argc</code> and <code>argv</code> to be in <code>rdi</code> and <code>rsi</code> respectively. First pointer in <code>argv</code> points to the executable name, and the second pointer (if provided) should point to <code>n</code>. Parsing can be done with a function from C stdlib:</p>
<div class="sourceCode" id="cb32" data-org-language="C"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="dt">long</span> strtol(<span class="dt">const</span> <span class="dt">char</span> *<span class="dt">restrict</span> str, <span class="dt">char</span> **<span class="dt">restrict</span> endptr, <span class="dt">int</span> base)</span></code></pre></div>
<p>With this in mind, let’s write an assembly program that echoes a number back to the console, or says that the provided value is not a number.</p>
<div class="sourceCode" id="cb33" data-startFrom data-tangle="echo-num.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb33-1"><a href="#cb33-1"></a>        GLOBAL _main</span>
<span id="cb33-2"><a href="#cb33-2"></a>        EXTERN _printf</span>
<span id="cb33-3"><a href="#cb33-3"></a>        EXTERN _strtol</span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb33-6"><a href="#cb33-6"></a></span>
<span id="cb33-7"><a href="#cb33-7"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb33-8"><a href="#cb33-8"></a>        usestr  <span class="dt">db</span>      <span class="st">'Usage: echo-num &lt;number&gt;'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb33-9"><a href="#cb33-9"></a>        nanstr  <span class="dt">db</span>      <span class="st">'Not a number'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>        numstr  <span class="dt">db</span>      <span class="st">'Your number is %d'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb33-11"><a href="#cb33-11"></a></span>
<span id="cb33-12"><a href="#cb33-12"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb33-13"><a href="#cb33-13"></a><span class="fu">_main:</span></span>
<span id="cb33-14"><a href="#cb33-14"></a>        <span class="bu">cmp</span>     <span class="kw">rdi</span>, <span class="dv">1</span></span>
<span id="cb33-15"><a href="#cb33-15"></a>        <span class="bu">jle</span>     .noargs</span>
<span id="cb33-16"><a href="#cb33-16"></a></span>
<span id="cb33-17"><a href="#cb33-17"></a>        <span class="bu">push</span>    <span class="kw">rbp</span>             <span class="co">; (1)</span></span>
<span id="cb33-18"><a href="#cb33-18"></a>        <span class="bu">mov</span>     <span class="kw">rbp</span>, <span class="kw">rsp</span>        <span class="co">;</span></span>
<span id="cb33-19"><a href="#cb33-19"></a></span>
<span id="cb33-20"><a href="#cb33-20"></a>        <span class="bu">lea</span>     <span class="kw">rax</span>, [<span class="kw">rsi</span> + <span class="dv">8</span>]  <span class="co">; (2)</span></span>
<span id="cb33-21"><a href="#cb33-21"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, [<span class="kw">rax</span>]      <span class="co">; rdi points to the first char of argv[1]</span></span>
<span id="cb33-22"><a href="#cb33-22"></a>        <span class="bu">call</span>    parsenum</span>
<span id="cb33-23"><a href="#cb33-23"></a></span>
<span id="cb33-24"><a href="#cb33-24"></a>        <span class="bu">cmp</span>     <span class="kw">rdx</span>, <span class="dv">0</span></span>
<span id="cb33-25"><a href="#cb33-25"></a>        <span class="bu">jne</span>     .invalid</span>
<span id="cb33-26"><a href="#cb33-26"></a></span>
<span id="cb33-27"><a href="#cb33-27"></a>        print1  numstr, <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb33-28"><a href="#cb33-28"></a>        <span class="bu">jmp</span>     .fin</span>
<span id="cb33-29"><a href="#cb33-29"></a></span>
<span id="cb33-30"><a href="#cb33-30"></a><span class="fu">.invalid:</span></span>
<span id="cb33-31"><a href="#cb33-31"></a>        print0  nanstr, <span class="dv">0</span></span>
<span id="cb33-32"><a href="#cb33-32"></a></span>
<span id="cb33-33"><a href="#cb33-33"></a><span class="fu">.fin:</span></span>
<span id="cb33-34"><a href="#cb33-34"></a>        <span class="bu">pop</span>     <span class="kw">rbp</span></span>
<span id="cb33-35"><a href="#cb33-35"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb33-36"><a href="#cb33-36"></a>        <span class="bu">ret</span></span>
<span id="cb33-37"><a href="#cb33-37"></a></span>
<span id="cb33-38"><a href="#cb33-38"></a><span class="fu">.noargs:</span></span>
<span id="cb33-39"><a href="#cb33-39"></a>        print0  usestr, <span class="dv">8</span></span>
<span id="cb33-40"><a href="#cb33-40"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">1</span></span>
<span id="cb33-41"><a href="#cb33-41"></a>        <span class="bu">ret</span></span>
<span id="cb33-42"><a href="#cb33-42"></a></span>
<span id="cb33-43"><a href="#cb33-43"></a><span class="co">;;; Parameter 1 - address of a string to parse</span></span>
<span id="cb33-44"><a href="#cb33-44"></a><span class="co">;;; Returns:</span></span>
<span id="cb33-45"><a href="#cb33-45"></a><span class="co">;;;     rax - parsed number</span></span>
<span id="cb33-46"><a href="#cb33-46"></a><span class="co">;;;     rdx - 0 when OK, 1 when the string is not a number</span></span>
<span id="cb33-47"><a href="#cb33-47"></a><span class="fu">parsenum:</span></span>
<span id="cb33-48"><a href="#cb33-48"></a>        <span class="bu">cmp</span>     <span class="dt">byte</span> [<span class="kw">rdi</span>], <span class="dv">0</span></span>
<span id="cb33-49"><a href="#cb33-49"></a>        <span class="bu">je</span>      .emptystr</span>
<span id="cb33-50"><a href="#cb33-50"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; align stack</span></span>
<span id="cb33-51"><a href="#cb33-51"></a></span>
<span id="cb33-52"><a href="#cb33-52"></a>        <span class="bu">mov</span>     <span class="kw">rsi</span>, <span class="kw">rsp</span>        <span class="co">; endptr on top of stack</span></span>
<span id="cb33-53"><a href="#cb33-53"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">10</span>         <span class="co">; base 10 number</span></span>
<span id="cb33-54"><a href="#cb33-54"></a>        <span class="bu">call</span>    _strtol</span>
<span id="cb33-55"><a href="#cb33-55"></a></span>
<span id="cb33-56"><a href="#cb33-56"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, [<span class="kw">rsp</span>]      <span class="co">; following 2 instructions dereference **endptr</span></span>
<span id="cb33-57"><a href="#cb33-57"></a>        <span class="bu">cmp</span>     <span class="dt">byte</span> [<span class="kw">rdx</span>], <span class="dv">0</span>   <span class="co">; and check that it points to 0 (end of string)</span></span>
<span id="cb33-58"><a href="#cb33-58"></a>        <span class="bu">jne</span>     .invalidstr     <span class="co">; otherwise input had some non-digit character</span></span>
<span id="cb33-59"><a href="#cb33-59"></a></span>
<span id="cb33-60"><a href="#cb33-60"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">0</span>          <span class="co">; rdx = 0 since parsing finished successfully</span></span>
<span id="cb33-61"><a href="#cb33-61"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; restore rsp</span></span>
<span id="cb33-62"><a href="#cb33-62"></a>        <span class="bu">ret</span></span>
<span id="cb33-63"><a href="#cb33-63"></a></span>
<span id="cb33-64"><a href="#cb33-64"></a><span class="fu">.invalidstr:</span>                    <span class="co">; invalidstr does the same as emptystr, but needs</span></span>
<span id="cb33-65"><a href="#cb33-65"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; to restore the stack</span></span>
<span id="cb33-66"><a href="#cb33-66"></a><span class="fu">.emptystr:</span></span>
<span id="cb33-67"><a href="#cb33-67"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb33-68"><a href="#cb33-68"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">1</span></span>
<span id="cb33-69"><a href="#cb33-69"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>Compile, run, and enjoy the result:</p>
<div class="sourceCode" id="cb34" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">make</span> echo-num <span class="op">&gt;</span> /dev/null</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="ex">bin/echo-num</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="ex">bin/echo-num</span> wat</span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="ex">bin/echo-num</span> 42</span></code></pre></div>
<pre class="example"><code>Usage: echo-num &lt;number&gt;
Not a number
Your number is 42
</code></pre>
<p>There are several things in the code that deserve further elaboration:</p>
<ol>
<li><p>This is what is usually called a <em>function prologue</em>. Conventionally, <code>rbp</code> points to the beginning of a stack frame. Instructions <code>push rbp; mov rbp, rsp;</code> enable access to the current stack frame, previous call stack frame, and recursively all stack frames up the call chain.</p>
<p>As a side effect, it also gets stack 16-byte aligned.</p></li>
<li><p>This <code>lea rax, [rsi + 8]</code> instruction is equivalent to <code>rax =
  rsi + 8</code> which stores in <code>rax</code> address of a second item in <code>argv</code> array. An alternative implementation could be <code>mov rax,
  rsi; add rax, 8;</code> but apart from requiring less instructions, on modern processors <code>lea</code> is also processed outside of ALU (in a different part of the execution pipeline that deals with addressing) and can happen in parallel with other arithmetic instructions.</p></li>
</ol>
<p>Similarly, to <code>printmacro.asm</code> let’s move <code>parsenum</code> to a separate file, and proceed to the final part.</p>
<div class="sourceCode" id="cb36" data-startFrom data-tangle="parse.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb36-1"><a href="#cb36-1"></a><span class="co">;;; Parameter 1 - address of a string to parse</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="co">;;; Returns:</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">;;;     rax - parsed number</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">;;;     rdx - 0 when OK, 1 when the string is not a number</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="fu">parsenum:</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>        <span class="bu">cmp</span>     <span class="dt">byte</span> [<span class="kw">rdi</span>], <span class="dv">0</span></span>
<span id="cb36-7"><a href="#cb36-7"></a>        <span class="bu">je</span>      .emptystr</span>
<span id="cb36-8"><a href="#cb36-8"></a>        <span class="bu">sub</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; align stack</span></span>
<span id="cb36-9"><a href="#cb36-9"></a></span>
<span id="cb36-10"><a href="#cb36-10"></a>        <span class="bu">mov</span>     <span class="kw">rsi</span>, <span class="kw">rsp</span>        <span class="co">; **endptr on top of stack</span></span>
<span id="cb36-11"><a href="#cb36-11"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">10</span>         <span class="co">; base 10 number</span></span>
<span id="cb36-12"><a href="#cb36-12"></a>        <span class="bu">call</span>    _strtol</span>
<span id="cb36-13"><a href="#cb36-13"></a></span>
<span id="cb36-14"><a href="#cb36-14"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, [<span class="kw">rsp</span>]      <span class="co">; following 2 instructions dereference **endptr</span></span>
<span id="cb36-15"><a href="#cb36-15"></a>        <span class="bu">cmp</span>     <span class="dt">byte</span> [<span class="kw">rdx</span>], <span class="dv">0</span>   <span class="co">; and check that it points to 0 (end of string)</span></span>
<span id="cb36-16"><a href="#cb36-16"></a>        <span class="bu">jne</span>     .invalidstr     <span class="co">; otherwise there is some non-digit character</span></span>
<span id="cb36-17"><a href="#cb36-17"></a></span>
<span id="cb36-18"><a href="#cb36-18"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">0</span>          <span class="co">; rdx = 0 since parsing finished successfully</span></span>
<span id="cb36-19"><a href="#cb36-19"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; restore rsp</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>        <span class="bu">ret</span></span>
<span id="cb36-21"><a href="#cb36-21"></a></span>
<span id="cb36-22"><a href="#cb36-22"></a><span class="fu">.invalidstr:</span>                    <span class="co">; invalidstr does the same as emptystr, but needs</span></span>
<span id="cb36-23"><a href="#cb36-23"></a>        <span class="bu">add</span>     <span class="kw">rsp</span>, <span class="dv">8</span>          <span class="co">; to restore the stack</span></span>
<span id="cb36-24"><a href="#cb36-24"></a><span class="fu">.emptystr:</span></span>
<span id="cb36-25"><a href="#cb36-25"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb36-26"><a href="#cb36-26"></a>        <span class="bu">mov</span>     <span class="kw">rdx</span>, <span class="dv">1</span></span>
<span id="cb36-27"><a href="#cb36-27"></a>        <span class="bu">ret</span></span></code></pre></div>
<h1 id="asm-sol">Finally, a solution to FizzBuzz</h1>
<p>The code below implements a straightforward solution that doesn’t use the fact that 3 and 5 are prime numbers. It’s also extensively commented for reader’s convenience.</p>
<div class="sourceCode" id="cb37" data-startFrom data-tangle="fizzbuzz.asm"><pre class="sourceCode numberSource asm numberLines"><code class="sourceCode fasm"><span id="cb37-1"><a href="#cb37-1"></a>        GLOBAL _main</span>
<span id="cb37-2"><a href="#cb37-2"></a>        EXTERN  _printf</span>
<span id="cb37-3"><a href="#cb37-3"></a>        EXTERN  _strtol</span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a>        %<span class="bu">include</span> <span class="st">&quot;printmacro.asm&quot;</span></span>
<span id="cb37-6"><a href="#cb37-6"></a>        %<span class="bu">include</span> <span class="st">&quot;parse.asm&quot;</span></span>
<span id="cb37-7"><a href="#cb37-7"></a></span>
<span id="cb37-8"><a href="#cb37-8"></a>        <span class="bu">SECTION</span> .<span class="bu">data</span></span>
<span id="cb37-9"><a href="#cb37-9"></a>        usestr  <span class="dt">db</span>      <span class="st">'Usage: fizzbuzz &lt;number&gt;'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb37-10"><a href="#cb37-10"></a>        nanstr  <span class="dt">db</span>      <span class="st">'Not a number'</span>, `\n`, <span class="dv">0</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>        numstr  <span class="dt">db</span>      <span class="st">'%d'</span>, <span class="dv">0</span></span>
<span id="cb37-12"><a href="#cb37-12"></a>        fizzstr <span class="dt">db</span>      <span class="st">'Fizz'</span>, <span class="dv">0</span></span>
<span id="cb37-13"><a href="#cb37-13"></a>        buzzstr <span class="dt">db</span>      <span class="st">'Buzz'</span>, <span class="dv">0</span></span>
<span id="cb37-14"><a href="#cb37-14"></a>        lf      <span class="dt">db</span>      `\n`, <span class="dv">0</span></span>
<span id="cb37-15"><a href="#cb37-15"></a></span>
<span id="cb37-16"><a href="#cb37-16"></a>        <span class="bu">SECTION</span> .text</span>
<span id="cb37-17"><a href="#cb37-17"></a><span class="fu">_main:</span></span>
<span id="cb37-18"><a href="#cb37-18"></a>        <span class="co">;; The beginning is the same as in echo-num.asm</span></span>
<span id="cb37-19"><a href="#cb37-19"></a>        <span class="bu">cmp</span>     <span class="kw">rdi</span>, <span class="dv">1</span></span>
<span id="cb37-20"><a href="#cb37-20"></a>        <span class="bu">jle</span>     .noargs</span>
<span id="cb37-21"><a href="#cb37-21"></a></span>
<span id="cb37-22"><a href="#cb37-22"></a>        <span class="bu">push</span>    <span class="kw">rbp</span></span>
<span id="cb37-23"><a href="#cb37-23"></a>        <span class="bu">mov</span>     <span class="kw">rbp</span>, <span class="kw">rsp</span></span>
<span id="cb37-24"><a href="#cb37-24"></a></span>
<span id="cb37-25"><a href="#cb37-25"></a>        <span class="bu">lea</span>     <span class="kw">rax</span>, [<span class="kw">rsi</span> + <span class="dv">8</span>]</span>
<span id="cb37-26"><a href="#cb37-26"></a>        <span class="bu">mov</span>     <span class="kw">rdi</span>, [<span class="kw">rax</span>]</span>
<span id="cb37-27"><a href="#cb37-27"></a>        <span class="bu">call</span>    parsenum</span>
<span id="cb37-28"><a href="#cb37-28"></a></span>
<span id="cb37-29"><a href="#cb37-29"></a>        <span class="bu">cmp</span>     <span class="kw">rdx</span>, <span class="dv">0</span></span>
<span id="cb37-30"><a href="#cb37-30"></a>        <span class="bu">jne</span>     .invalid</span>
<span id="cb37-31"><a href="#cb37-31"></a>        <span class="co">;; At this point n is parsed and is in rax register</span></span>
<span id="cb37-32"><a href="#cb37-32"></a></span>
<span id="cb37-33"><a href="#cb37-33"></a>        <span class="co">;; Here starts the main logic of the routine.</span></span>
<span id="cb37-34"><a href="#cb37-34"></a>        <span class="co">;; Since registers r12 - r15 are calee-saved, they</span></span>
<span id="cb37-35"><a href="#cb37-35"></a>        <span class="co">;; need to be pushed onto the stack before using.</span></span>
<span id="cb37-36"><a href="#cb37-36"></a>        <span class="bu">push</span>    <span class="kw">r13</span></span>
<span id="cb37-37"><a href="#cb37-37"></a>        <span class="bu">mov</span>     <span class="kw">r13</span>, <span class="kw">rax</span>        <span class="co">; save n in r13</span></span>
<span id="cb37-38"><a href="#cb37-38"></a></span>
<span id="cb37-39"><a href="#cb37-39"></a>        <span class="bu">push</span>    <span class="kw">r12</span>             <span class="co">; r12 will serve as a counter</span></span>
<span id="cb37-40"><a href="#cb37-40"></a>        <span class="bu">mov</span>     <span class="kw">r12</span>, <span class="dv">1</span></span>
<span id="cb37-41"><a href="#cb37-41"></a></span>
<span id="cb37-42"><a href="#cb37-42"></a>        <span class="bu">push</span>    <span class="kw">r14</span>             <span class="co">; r14 will store r12 % 3</span></span>
<span id="cb37-43"><a href="#cb37-43"></a></span>
<span id="cb37-44"><a href="#cb37-44"></a><span class="fu">.checkStart:</span></span>
<span id="cb37-45"><a href="#cb37-45"></a>        <span class="bu">cmp</span>     <span class="kw">r12</span>, <span class="kw">r13</span></span>
<span id="cb37-46"><a href="#cb37-46"></a>        <span class="bu">jg</span>      .fin</span>
<span id="cb37-47"><a href="#cb37-47"></a></span>
<span id="cb37-48"><a href="#cb37-48"></a>        <span class="co">;; div instruction does signed division</span></span>
<span id="cb37-49"><a href="#cb37-49"></a>        <span class="co">;; when the divisor is in 64-bit register (rcx in our case)</span></span>
<span id="cb37-50"><a href="#cb37-50"></a>        <span class="co">;; rdx:rax get divided by it with quotient stored in rax and</span></span>
<span id="cb37-51"><a href="#cb37-51"></a>        <span class="co">;; remainder -- in rdx</span></span>
<span id="cb37-52"><a href="#cb37-52"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="kw">r12</span></span>
<span id="cb37-53"><a href="#cb37-53"></a>        <span class="bu">xor</span>     <span class="kw">rdx</span>, <span class="kw">rdx</span></span>
<span id="cb37-54"><a href="#cb37-54"></a>        <span class="bu">mov</span>     <span class="kw">rcx</span>, <span class="dv">3</span></span>
<span id="cb37-55"><a href="#cb37-55"></a>        <span class="bu">div</span>     <span class="kw">rcx</span></span>
<span id="cb37-56"><a href="#cb37-56"></a></span>
<span id="cb37-57"><a href="#cb37-57"></a>        <span class="bu">mov</span>     <span class="kw">r14</span>, <span class="kw">rdx</span>        <span class="co">; save r13 % 3 in r14 for further check in .checkNum</span></span>
<span id="cb37-58"><a href="#cb37-58"></a>        <span class="bu">cmp</span>     <span class="kw">rdx</span>, <span class="dv">0</span></span>
<span id="cb37-59"><a href="#cb37-59"></a>        <span class="bu">jne</span>     .check5</span>
<span id="cb37-60"><a href="#cb37-60"></a>        print0  fizzstr, <span class="dv">8</span></span>
<span id="cb37-61"><a href="#cb37-61"></a>        <span class="co">;; after .check3 we *need* to fall-through to .check5</span></span>
<span id="cb37-62"><a href="#cb37-62"></a><span class="fu">.check5:</span></span>
<span id="cb37-63"><a href="#cb37-63"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="kw">r12</span></span>
<span id="cb37-64"><a href="#cb37-64"></a>        <span class="bu">xor</span>     <span class="kw">rdx</span>, <span class="kw">rdx</span></span>
<span id="cb37-65"><a href="#cb37-65"></a>        <span class="bu">mov</span>     <span class="kw">rcx</span>, <span class="dv">5</span></span>
<span id="cb37-66"><a href="#cb37-66"></a>        <span class="bu">div</span>     <span class="kw">rcx</span></span>
<span id="cb37-67"><a href="#cb37-67"></a>        <span class="bu">cmp</span>     <span class="kw">rdx</span>, <span class="dv">0</span></span>
<span id="cb37-68"><a href="#cb37-68"></a>        <span class="bu">jne</span>     .checkNum</span>
<span id="cb37-69"><a href="#cb37-69"></a>        print0  buzzstr, <span class="dv">8</span></span>
<span id="cb37-70"><a href="#cb37-70"></a>        <span class="bu">jmp</span>     .checkEnd       <span class="co">; check5 is successful, we can go to .checkEnd</span></span>
<span id="cb37-71"><a href="#cb37-71"></a></span>
<span id="cb37-72"><a href="#cb37-72"></a><span class="fu">.checkNum:</span></span>
<span id="cb37-73"><a href="#cb37-73"></a>        <span class="bu">cmp</span>     <span class="kw">r14</span>, <span class="dv">0</span>          <span class="co">; here r12 % 5 != 0, *but* r12 % 3 could be 0</span></span>
<span id="cb37-74"><a href="#cb37-74"></a>        <span class="bu">je</span>      .checkEnd       <span class="co">; thus we need to check the result of div 3</span></span>
<span id="cb37-75"><a href="#cb37-75"></a>        print1  numstr, <span class="kw">r12</span>, <span class="dv">8</span></span>
<span id="cb37-76"><a href="#cb37-76"></a></span>
<span id="cb37-77"><a href="#cb37-77"></a><span class="fu">.checkEnd:</span></span>
<span id="cb37-78"><a href="#cb37-78"></a>        print0  lf, <span class="dv">8</span></span>
<span id="cb37-79"><a href="#cb37-79"></a>        <span class="bu">inc</span>     <span class="kw">r12</span></span>
<span id="cb37-80"><a href="#cb37-80"></a>        <span class="bu">jmp</span>     .checkStart</span>
<span id="cb37-81"><a href="#cb37-81"></a></span>
<span id="cb37-82"><a href="#cb37-82"></a><span class="fu">.fin:</span></span>
<span id="cb37-83"><a href="#cb37-83"></a>        <span class="bu">pop</span>     <span class="kw">r14</span></span>
<span id="cb37-84"><a href="#cb37-84"></a>        <span class="bu">pop</span>     <span class="kw">r12</span></span>
<span id="cb37-85"><a href="#cb37-85"></a>        <span class="bu">pop</span>     <span class="kw">r13</span></span>
<span id="cb37-86"><a href="#cb37-86"></a>        <span class="bu">pop</span>     <span class="kw">rbp</span></span>
<span id="cb37-87"><a href="#cb37-87"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">0</span></span>
<span id="cb37-88"><a href="#cb37-88"></a>        <span class="bu">ret</span></span>
<span id="cb37-89"><a href="#cb37-89"></a></span>
<span id="cb37-90"><a href="#cb37-90"></a><span class="fu">.noargs:</span></span>
<span id="cb37-91"><a href="#cb37-91"></a>        print0  usestr, <span class="dv">8</span></span>
<span id="cb37-92"><a href="#cb37-92"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">1</span></span>
<span id="cb37-93"><a href="#cb37-93"></a>        <span class="bu">ret</span></span>
<span id="cb37-94"><a href="#cb37-94"></a></span>
<span id="cb37-95"><a href="#cb37-95"></a><span class="fu">.invalid:</span></span>
<span id="cb37-96"><a href="#cb37-96"></a>        print0  nanstr, <span class="dv">0</span></span>
<span id="cb37-97"><a href="#cb37-97"></a>        <span class="bu">pop</span>     <span class="kw">rbp</span></span>
<span id="cb37-98"><a href="#cb37-98"></a>        <span class="bu">mov</span>     <span class="kw">rax</span>, <span class="dv">1</span></span>
<span id="cb37-99"><a href="#cb37-99"></a>        <span class="bu">ret</span></span></code></pre></div>
<p>Now, run it and stand back in amazement as the solution is being printed onto the screen:</p>
<div class="sourceCode" id="cb38" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">make</span> fizzbuzz <span class="op">&gt;</span> /dev/null</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="ex">bin/fizzbuzz</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="ex">bin/fizzbuzz</span> wat</span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="ex">bin/fizzbuzz</span> 15</span></code></pre></div>
<pre class="example"><code>Usage: fizzbuzz &lt;number&gt;
Not a number
1
2
Fizz
4
Buzz
Fizz
7
8
Fizz
Buzz
11
Fizz
13
14
FizzBuzz
</code></pre>
<p>To conclude, there are several things we covered in this post, including:</p>
<ul>
<li>how to use library functions,</li>
<li>how to link programs with shared libraries,</li>
<li>what are static and dynamic linking, what is <em>relocation</em> and how lazy binding is happening at runtime,</li>
<li>stack alignment and whether it’s necessary at all times,</li>
<li>more assembly tricks, macros and function definitions.</li>
</ul>
<p>Although, the low level mechanics are rather fiddly, understanding how compilation, linking and loading work as well as being able to read resulting assembly can help in debugging some baffling otherwise issues.</p>
<h1 id="other-lang-sols">(Bonus) FizzBuzz in other languages</h1>
<p><strong>Disclaimer</strong>: this sections is written just for lulz, no hard conclusions should be drawn from it.</p>
<p>Out of curiosity, let’s calculate the execution time of a solution in assembly for a modest <code>n = 10M</code>:</p>
<div class="sourceCode" id="cb40" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="ex">bin/fizzbuzz</span> 10000000 <span class="op">&gt;</span> /dev/null</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="bu">times</span></span></code></pre></div>
<pre class="example"><code>0m0.002s 0m0.003s
0m1.993s 0m0.004s
</code></pre>
<p>A bit less than 2s, which is not bad at all! After all, it’s as close to the bare metal as possible, so it should be very performant, right? Well, yes… maybe. Let’s find out!</p>
<h2 id="c-sol">Effectiveness of C</h2>
<p>Below is a pretty direct translation of the assembly solution to C:</p>
<div class="sourceCode" id="cb42" data-org-language="C" data-startFrom data-tangle="c-fizzbuzz.c"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="pp">#include </span><span class="im">&lt;inttypes.h&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4"></a></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">const</span> <span class="dt">char</span> *argv[])</span>
<span id="cb42-6"><a href="#cb42-6"></a>{</span>
<span id="cb42-7"><a href="#cb42-7"></a>        <span class="cf">if</span> (argc &lt; <span class="dv">2</span>) {</span>
<span id="cb42-8"><a href="#cb42-8"></a>                printf(<span class="st">&quot;Usage: c-fizzbuzz &lt;number&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb42-9"><a href="#cb42-9"></a>                <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb42-10"><a href="#cb42-10"></a>        }</span>
<span id="cb42-11"><a href="#cb42-11"></a></span>
<span id="cb42-12"><a href="#cb42-12"></a>        <span class="dt">char</span> *endptr;</span>
<span id="cb42-13"><a href="#cb42-13"></a>        <span class="dt">long</span> n = strtol(argv[<span class="dv">1</span>], &amp;endptr, <span class="dv">10</span>);</span>
<span id="cb42-14"><a href="#cb42-14"></a>        <span class="cf">if</span> (endptr[<span class="dv">0</span>] != <span class="ch">'\0'</span>) {</span>
<span id="cb42-15"><a href="#cb42-15"></a>                printf(<span class="st">&quot;Error: not a number</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb42-16"><a href="#cb42-16"></a>                <span class="cf">return</span> <span class="dv">1</span>;</span>
<span id="cb42-17"><a href="#cb42-17"></a>        }</span>
<span id="cb42-18"><a href="#cb42-18"></a></span>
<span id="cb42-19"><a href="#cb42-19"></a>        <span class="cf">for</span> (<span class="dt">long</span> i = <span class="dv">1</span>; i &lt;= n; i++) {</span>
<span id="cb42-20"><a href="#cb42-20"></a>                <span class="dt">long</span> rem3 = i % <span class="dv">3</span>;</span>
<span id="cb42-21"><a href="#cb42-21"></a>                <span class="dt">long</span> rem5 = i % <span class="dv">5</span>;</span>
<span id="cb42-22"><a href="#cb42-22"></a>                <span class="cf">if</span> (rem3 == <span class="dv">0</span>) {</span>
<span id="cb42-23"><a href="#cb42-23"></a>                        printf(<span class="st">&quot;Fizz&quot;</span>);</span>
<span id="cb42-24"><a href="#cb42-24"></a>                }</span>
<span id="cb42-25"><a href="#cb42-25"></a>                <span class="cf">if</span> (rem5 == <span class="dv">0</span>) {</span>
<span id="cb42-26"><a href="#cb42-26"></a>                        printf(<span class="st">&quot;Buzz&quot;</span>);</span>
<span id="cb42-27"><a href="#cb42-27"></a>                } <span class="cf">else</span> {</span>
<span id="cb42-28"><a href="#cb42-28"></a>                        <span class="cf">if</span> (rem3 != <span class="dv">0</span>) {</span>
<span id="cb42-29"><a href="#cb42-29"></a>                                printf(<span class="st">&quot;%ld&quot;</span>, i);</span>
<span id="cb42-30"><a href="#cb42-30"></a>                        }</span>
<span id="cb42-31"><a href="#cb42-31"></a>                }</span>
<span id="cb42-32"><a href="#cb42-32"></a>                printf(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb42-33"><a href="#cb42-33"></a>        }</span>
<span id="cb42-34"><a href="#cb42-34"></a></span>
<span id="cb42-35"><a href="#cb42-35"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb42-36"><a href="#cb42-36"></a>}</span></code></pre></div>
<p>Checking that it compiles and runs fine:</p>
<div class="sourceCode" id="cb43" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a><span class="fu">cc</span> c-fizzbuzz.c -o bin/c-fizzbuzz</span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="ex">bin/c-fizzbuzz</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="ex">bin/c-fizzbuzz</span> wat</span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="ex">bin/c-fizzbuzz</span> 15</span></code></pre></div>
<pre class="example"><code>Usage: c-fizzbuzz &lt;number&gt;
Error: not a number
1
2
Fizz
4
Buzz
Fizz
7
8
Fizz
Buzz
11
Fizz
13
14
FizzBuzz
</code></pre>
<p>Good. In regard to the timings, we get a bit more than 2s, which agrees with the intuition — compilers generate great assembly, but there is still small level of overhead:</p>
<div class="sourceCode" id="cb45" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1"></a><span class="ex">bin/c-fizzbuzz</span> 10000000 <span class="op">&gt;</span> /dev/null</span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="bu">times</span></span></code></pre></div>
<pre class="example"><code>0m0.002s 0m0.002s
0m2.075s 0m0.004s
</code></pre>
<p>Case solved? Not exactly. Let’s compile the code with the maximum optimization level, and time the execution again:</p>
<div class="sourceCode" id="cb47" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1"></a><span class="fu">cc</span> c-fizzbuzz.c -o bin/c-fizzbuzz -O3</span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="ex">bin/c-fizzbuzz</span> 10000000 <span class="op">&gt;</span> /dev/null</span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="bu">times</span></span></code></pre></div>
<pre class="example"><code>0m0.002s 0m0.002s
0m1.621s 0m0.034s
</code></pre>
<p>Now we’re at ~1.6s which is ~23% and ~28% faster than “pure assembly” and “no-optimization C” solutions respectively. Compiler developers try hard to improve the efficiency of the generated assembly. Writing assembly by hand is cool, but C compilers apply lots of non-trivial optimizations to the code without programmers even knowing or understanding this optimizations.</p>
<p>In this particular case, <code>clang</code> optimized a couple things:</p>
<ul>
<li>Replaced calls to <code>printf</code> without parameters with <code>puts</code>, thus avoiding the overhead of needlessly parsing a format string.</li>
<li>Used an optimized remainder calculation. In general, division is a costly operation and can take 10s of CPU cycles. But if the divisor is known, remainder can be found quicker without using division<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
</ul>
<h2 id="haskell-sol">Expressiveness of Haskell</h2>
<p>The M-word was used only once in the source code. It may not be the most idiomatic Haskell, but it closely resembles other solutions and is arguably easy to read.</p>
<div class="sourceCode" id="cb49" data-startFrom data-tangle="hs-fizzbuzz.hs"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">import</span> <span class="dt">System.Environment</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="kw">import</span> <span class="dt">Data.List</span> (uncons)</span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (forM_, when, unless)</span>
<span id="cb49-4"><a href="#cb49-4"></a></span>
<span id="cb49-5"><a href="#cb49-5"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb49-6"><a href="#cb49-6"></a>  args <span class="ot">&lt;-</span> getArgs</span>
<span id="cb49-7"><a href="#cb49-7"></a></span>
<span id="cb49-8"><a href="#cb49-8"></a>  <span class="kw">case</span> headMay args <span class="kw">of</span></span>
<span id="cb49-9"><a href="#cb49-9"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> printUsage</span>
<span id="cb49-10"><a href="#cb49-10"></a>    <span class="dt">Just</span> nStr  <span class="ot">-&gt;</span> <span class="kw">case</span> parseNum nStr <span class="kw">of</span></span>
<span id="cb49-11"><a href="#cb49-11"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> printNanError</span>
<span id="cb49-12"><a href="#cb49-12"></a>      <span class="dt">Just</span> n <span class="ot">-&gt;</span> solveFizzBuzz n</span>
<span id="cb49-13"><a href="#cb49-13"></a></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="co">----------------------------------------------------------</span></span>
<span id="cb49-15"><a href="#cb49-15"></a><span class="co">-- FizzBuzz solution</span></span>
<span id="cb49-16"><a href="#cb49-16"></a><span class="co">----------------------------------------------------------</span></span>
<span id="cb49-17"><a href="#cb49-17"></a>solveFizzBuzz nMax <span class="ot">=</span> forM_ [<span class="dv">1</span><span class="op">..</span>nMax] <span class="op">$</span> \n <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb49-18"><a href="#cb49-18"></a>  <span class="kw">let</span> rem3 <span class="ot">=</span> n <span class="ot">`rem`</span> <span class="dv">3</span></span>
<span id="cb49-19"><a href="#cb49-19"></a>      rem5 <span class="ot">=</span> n <span class="ot">`rem`</span> <span class="dv">5</span></span>
<span id="cb49-20"><a href="#cb49-20"></a></span>
<span id="cb49-21"><a href="#cb49-21"></a>  when (rem3 <span class="op">==</span> <span class="dv">0</span>) <span class="op">$</span> <span class="fu">putStr</span> <span class="st">&quot;Fizz&quot;</span></span>
<span id="cb49-22"><a href="#cb49-22"></a></span>
<span id="cb49-23"><a href="#cb49-23"></a>  <span class="kw">if</span> rem5 <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb49-24"><a href="#cb49-24"></a>     <span class="kw">then</span> <span class="fu">putStr</span> <span class="st">&quot;Buzz&quot;</span></span>
<span id="cb49-25"><a href="#cb49-25"></a>     <span class="kw">else</span> unless (rem3 <span class="op">==</span> <span class="dv">0</span>) <span class="op">$</span> <span class="fu">putStr</span> (<span class="fu">show</span> n)</span>
<span id="cb49-26"><a href="#cb49-26"></a></span>
<span id="cb49-27"><a href="#cb49-27"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;&quot;</span></span>
<span id="cb49-28"><a href="#cb49-28"></a></span>
<span id="cb49-29"><a href="#cb49-29"></a><span class="co">----------------------------------------------------------</span></span>
<span id="cb49-30"><a href="#cb49-30"></a><span class="co">-- Helper functions</span></span>
<span id="cb49-31"><a href="#cb49-31"></a><span class="co">----------------------------------------------------------</span></span>
<span id="cb49-32"><a href="#cb49-32"></a></span>
<span id="cb49-33"><a href="#cb49-33"></a>printUsage <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;Usage: hs-fizzbuzz &lt;number&gt;&quot;</span></span>
<span id="cb49-34"><a href="#cb49-34"></a>printNanError <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;Error: Not a number&quot;</span></span>
<span id="cb49-35"><a href="#cb49-35"></a></span>
<span id="cb49-36"><a href="#cb49-36"></a><span class="ot">headMay ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb49-37"><a href="#cb49-37"></a>headMay xs <span class="ot">=</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> uncons xs</span>
<span id="cb49-38"><a href="#cb49-38"></a></span>
<span id="cb49-39"><a href="#cb49-39"></a><span class="ot">parseNum ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb49-40"><a href="#cb49-40"></a>parseNum s <span class="ot">=</span> <span class="kw">case</span> <span class="fu">reads</span> s <span class="kw">of</span></span>
<span id="cb49-41"><a href="#cb49-41"></a>  (n, <span class="st">&quot;&quot;</span>) <span class="op">:</span> xs <span class="ot">-&gt;</span> <span class="dt">Just</span> n</span>
<span id="cb49-42"><a href="#cb49-42"></a>  _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>Compiling with the maximum optimization level gives the execution time of ~5.49s:</p>
<div class="sourceCode" id="cb50" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1"></a><span class="ex">ghc</span> -o bin/hs-fizzbuzz -O2 hs-fizzbuzz.hs</span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="ex">bin/hs-fizzbuzz</span> 10000000 <span class="op">&gt;</span> /dev/null</span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="bu">times</span></span></code></pre></div>
<pre class="example"><code>0m0.002s 0m0.003s
0m5.486s 0m0.108s
</code></pre>
<p>I’m not an expert in Haskell performance tuning, so there might be a way to implement this more efficiently. But again, these numbers should not be used to argue that FP is slow — this is a degenerate example where the overhead is noticeable. On a real project the compiler will have many more optimization opportunities.</p>
<h2 id="python-sol">Whatever of Python</h2>
<p>I figured that the list would be incomplete without an interpreted language, so here is a solution in Python:</p>
<div class="sourceCode" id="cb52" data-startFrom data-tangle="py-fizzbuzz.py"><pre class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="im">import</span> sys</span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="kw">def</span> main():</span>
<span id="cb52-4"><a href="#cb52-4"></a>    <span class="cf">if</span> <span class="bu">len</span>(sys.argv) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb52-5"><a href="#cb52-5"></a>        <span class="bu">print</span>(<span class="st">&quot;Usage: py-fizzbuzz &lt;number&gt;&quot;</span>)</span>
<span id="cb52-6"><a href="#cb52-6"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb52-7"><a href="#cb52-7"></a></span>
<span id="cb52-8"><a href="#cb52-8"></a>    <span class="cf">try</span>:</span>
<span id="cb52-9"><a href="#cb52-9"></a>        n <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb52-10"><a href="#cb52-10"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb52-11"><a href="#cb52-11"></a>        <span class="bu">print</span>(<span class="st">&quot;Error: Not a number&quot;</span>)</span>
<span id="cb52-12"><a href="#cb52-12"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb52-13"><a href="#cb52-13"></a></span>
<span id="cb52-14"><a href="#cb52-14"></a>    solveFizzBuzz(n)</span>
<span id="cb52-15"><a href="#cb52-15"></a></span>
<span id="cb52-16"><a href="#cb52-16"></a><span class="kw">def</span> solveFizzBuzz(n):</span>
<span id="cb52-17"><a href="#cb52-17"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb52-18"><a href="#cb52-18"></a>        rem3 <span class="op">=</span> i <span class="op">%</span> <span class="dv">3</span></span>
<span id="cb52-19"><a href="#cb52-19"></a>        rem5 <span class="op">=</span> i <span class="op">%</span> <span class="dv">5</span></span>
<span id="cb52-20"><a href="#cb52-20"></a></span>
<span id="cb52-21"><a href="#cb52-21"></a>        <span class="cf">if</span> (rem3 <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb52-22"><a href="#cb52-22"></a>            <span class="bu">print</span>(<span class="st">&quot;Fizz&quot;</span>, end<span class="op">=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb52-23"><a href="#cb52-23"></a></span>
<span id="cb52-24"><a href="#cb52-24"></a>        <span class="cf">if</span> (rem5 <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb52-25"><a href="#cb52-25"></a>            <span class="bu">print</span>(<span class="st">&quot;Buzz&quot;</span>, end<span class="op">=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb52-26"><a href="#cb52-26"></a>        <span class="cf">else</span>:</span>
<span id="cb52-27"><a href="#cb52-27"></a>            <span class="cf">if</span> (rem3 <span class="op">!=</span> <span class="dv">0</span>):</span>
<span id="cb52-28"><a href="#cb52-28"></a>                <span class="bu">print</span>(i, end<span class="op">=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb52-29"><a href="#cb52-29"></a></span>
<span id="cb52-30"><a href="#cb52-30"></a>        <span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb52-31"><a href="#cb52-31"></a></span>
<span id="cb52-32"><a href="#cb52-32"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb52-33"><a href="#cb52-33"></a>    main()</span></code></pre></div>
<p>The code resembles Haskell’s version a lot (minus type annotations). The timings are not that bad — about 3x slower than Haskell’s version and 10x slower then C:</p>
<div class="sourceCode" id="cb53" data-startFrom data-results="output"><pre class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1"></a><span class="ex">python3</span> py-fizzbuzz.py 10000000 <span class="op">&gt;</span> /dev/null</span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="bu">times</span></span></code></pre></div>
<pre class="example"><code>0m0.002s 0m0.004s
0m14.858s 0m0.039s
</code></pre>
<h1 id="footnotes">Footnotes</h1>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>There <strong>are</strong> instructions in <code>printf</code> that require memory alignment, but this code path is not taken during execution due to absence of floating point arguments.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Loosely speaking, the assembler doesn’t know the final address of a symbol in memory. So, it puts a placeholder in the object file, and instructs the linker to put the final address there when the linker builds an executable. This process is called <strong>relocation</strong>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>Or more specifically, a program counter (PC) relative displacement.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><code>__la_...</code> stands for lazy and <code>_nl_...</code> — for non-lazy and describe the type of binding performed by the dynamic linker.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>The actual memory content is <code>f41f0000</code> but due to little-endianness byte order is reversed and the least significant byte comes first.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Remainder from division by 3 or by 5 can be found more efficiently using a combination of multiplication and shifts. See <a href="https://www.hackersdelight.org/hdcodetxt/remuc.c.txt">Hacker’s delight</a> for more details. Looks like in this particular case <code>remu3m</code> and <code>remu5m</code> methods were used.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
    </section>
</article>

  </main>

  <footer>
    <nav class="footer-nav">

      <a class="footer-nav-item" href="../">
        <span class="fa fa-home fa-lg"></span>
      </a>

      <a class="footer-nav-item" href="https://github.com/artempyanykh">
        <span class="fa fa-github fa-lg"></span>
      </a>

      <a class="footer-nav-item" href="https://ru.linkedin.com/in/artempyanykh/en">
        <span class="fa fa-linkedin fa-lg"></span>
      </a>

      <a class="footer-nav-item" href="https://twitter.com/artem_pyanykh">
        <span class="fa fa-twitter fa-lg"></span>
      </a>

      <a class="footer-nav-item" href="../about.html">
        <span class="fa fa-question fa-lg"></span>
      </a>
    </nav>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>

</body>

</html>